<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hansol Textile Â· Market Insight</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { margin:0; font-family:'Segoe UI',sans-serif; background:#fff; color:#111;}
    header { padding:1rem 1.5rem; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;}
    header h1 { font-size:1.2rem; margin:0; font-weight:600; color:#005BAC;}
    header small { font-size:0.85rem; color:#666;}
    main { padding:1.5rem; display:grid; gap:2rem; max-width:1200px; margin:auto;}
    h2 { margin:0 0 1rem; font-size:1.1rem; font-weight:600; color:#333;}
    .stocks { width:100%; border-collapse:collapse; font-size:0.9rem; border:1px solid #eee; border-radius:8px; overflow:hidden;}
    .stocks th, .stocks td { padding:0.8rem; border-bottom:1px solid #eee; text-align:center;}
    .stocks th { background:#fafafa; font-weight:600;}
    .stocks tr:last-child td { border-bottom:none;}
    .price { font-size:1.1rem; font-weight:600;}
    .positive { color:#1FA857; font-weight:600;}
    .negative { color:#D64541; font-weight:600;}
    .sparkline { width:150px; height:50px;}
    .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:1rem;}
    .card { border:1px solid #eee; border-radius:12px; padding:1rem; background:#fafafa;}
    .card strong { display:block; font-size:0.85rem; color:#666;}
    .card .value { font-size:1.2rem; font-weight:600; margin-top:0.2rem;}
    footer { padding:1rem; text-align:center; font-size:0.8rem; color:#888; border-top:1px solid #eee;}
  </style>
</head>
<body>
  <header>
    <h1>Hansol Textile Â· Market Insight</h1>
    <small id="date"></small>
  </header>
  <main>
    <section id="stocks">
      <h2>ğŸ“Š ë¦¬í…Œì¼ëŸ¬ ì£¼ê°€ & ë‰´ìŠ¤</h2>
      <table class="stocks" id="stocks-table">
        <thead>
          <tr><th>Ticker</th><th>Name</th><th>Price</th><th>Change</th><th>1M Trend</th><th>News</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
    <section id="kpi">
      <h2>ğŸ“ˆ íŒ¨ì…˜Â·ë¦¬í…Œì¼ ì£¼ìš” ì§€í‘œ (FRED)</h2>
      <div class="grid" id="kpi-cards"></div>
    </section>
    <section id="ai-analysis">
      <h2>ğŸ¤– AI ì‹œí™©ë¶„ì„</h2>
      <div id="analysis-box" style="padding:1rem; border:1px solid #eee; border-radius:8px; background:#fafafa;"></div>
    </section>
  </main>
  <footer>
    Â© Hansol Textile Â· Purchasing Division
  </footer>

<script>
async function loadStocks() { const r=await fetch("/api/stocks"); return r.json(); }
async function loadFRED() { const r=await fetch("/api/fred"); return r.json(); }
async function loadAnalysis() { const r=await fetch("/api/analysis"); return r.json(); }

function formatValue(val, unit) {
  if (val === "." || val === undefined) return "-";
  const num = parseFloat(val);
  switch (unit) {
    case "%": return num.toFixed(2) + "%";
    case "$": 
      if (num > 1e9) return "$" + (num/1e9).toFixed(2) + "B";
      if (num > 1e6) return "$" + (num/1e6).toFixed(2) + "M";
      return "$" + num.toFixed(2);
    case "index": return num.toFixed(2);
    default: return num;
  }
}
function formatChange(change) {
  if (change === null) return "";
  return change >= 0 
    ? `<span style="color:#1FA857">â–² ${change.toFixed(2)}%</span>`
    : `<span style="color:#D64541">â–¼ ${Math.abs(change).toFixed(2)}%</span>`;
}

async function renderStocks(stocks) {
  const tbody = document.querySelector("#stocks-table tbody");
  stocks.forEach((r, idx) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.symbol}</td>
      <td>${r.name || "-"}</td>
      <td class="price">${r.price.toFixed(2)}</td>
      <td>${r.change >= 0 
          ? `<span class="positive">â–² ${r.change.toFixed(2)}%</span>`
          : `<span class="negative">â–¼ ${Math.abs(r.change).toFixed(2)}%</span>`}
      </td>
      <td><canvas id="chart-${idx}" class="sparkline"></canvas></td>
      <td><div id="news-${idx}"></div></td>
    `;
    tbody.appendChild(tr);

    // ì°¨íŠ¸
    const labels = r.history.map(h => new Date(h.date).toLocaleDateString("ko-KR",{month:"numeric", day:"numeric"}));
    const data = r.history.map(h => h.close);
    new Chart(document.getElementById("chart-"+idx), {
      type: 'line',
      data: { labels, datasets: [{ data, borderColor:(r.change>=0?"#1FA857":"#D64541"), borderWidth:2, fill:false, tension:0.2, pointRadius:0 }]},
      options: { plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{display:false}} }
    });

    // ë‰´ìŠ¤
    const newsBox = document.getElementById("news-"+idx);
    r.news.forEach(n => {
      const div = document.createElement("div");
      const date = new Date(n.providerPublishTime*1000).toLocaleDateString("ko-KR");
      div.innerHTML = `<a href="${n.link}" target="_blank">${n.title}</a><br><small>${n.publisher} Â· ${date}</small>`;
      newsBox.appendChild(div);
    });
  });
}
async function renderKPI() {
  const fredData = await loadFRED();
  const kpiDiv = document.getElementById("kpi-cards");
  fredData.forEach(k => {
    const card = document.createElement("div");
    card.className="card";
    card.innerHTML = `
      <strong>${k.name}</strong>
      <div class="value">${formatValue(k.value,k.unit)} ${formatChange(k.change)}</div>
      <small>${new Date(k.date).toLocaleDateString("ko-KR")}</small>
    `;
    kpiDiv.appendChild(card);
  });
}
async function renderAnalysis() {
  const {analysis} = await loadAnalysis();
  document.getElementById("analysis-box").innerText = analysis;
}
async function init(){
  document.getElementById("date").textContent = new Date().toLocaleString();
  const stocks = await loadStocks(); renderStocks(stocks);
  await renderKPI();
  await renderAnalysis();
}
init();
</script>
</body>
</html>
