<!-- 3. 주요 Retailer 주가 -->
<h3 class="section-title">3. 주요 Retailer 주가</h3>
<div class="row g-3" id="retailers"></div>

<script>
  const retailers = [
    { code: "WMT", name: "Walmart" },
    { code: "TGT", name: "Target" },
    { code: "KSS", name: "Kohl's" },
    { code: "VSCO", name: "Victoria's Secret" },
    { code: "ANF", name: "Abercrombie & Fitch" },
    { code: "CRI", name: "Carter's" },
    { code: "9983.T", name: "Fast Retailing (Uniqlo)" },
    { code: "AMZN", name: "Amazon" },
    { code: "BABA", name: "Alibaba.com" }
  ];

  async function fetchStock(symbol) {
    try {
      const res = await fetch(`/api/stocks?symbol=${encodeURIComponent(symbol)}`);
      if (!res.ok) throw new Error("API 요청 실패");
      return await res.json();
    } catch (err) {
      console.error(symbol, err);
      return { error: true, symbol };
    }
  }

  async function fetchNews(query) {
    try {
      const res = await fetch(`/api/news?q=${encodeURIComponent(query)}`);
      if (!res.ok) throw new Error("뉴스 API 요청 실패");
      return await res.json();
    } catch (err) {
      console.error("뉴스 오류:", query, err);
      return { articles: [] };
    }
  }

  async function fetchAnalysis(name, price, news) {
    try {
      const res = await fetch("/api/analysis", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, price, news }),
      });
      if (!res.ok) throw new Error("분석 API 실패");
      return await res.json();
    } catch (err) {
      console.error("AI 분석 오류:", err);
      return { summary: "분석 불가" };
    }
  }

  async function loadRetailers() {
    const container = document.getElementById("retailers");
    container.innerHTML = "";

    for (const r of retailers) {
      const [data, newsData] = await Promise.all([
        fetchStock(r.code),
        fetchNews(r.name)
      ]);

      const col = document.createElement("div");
      col.className = "col-md-6";

      if (data.error) {
        col.innerHTML = `
          <div class="card p-3 mb-3">
            <h6>${r.name} (${r.code})</h6>
            <p class="text-danger">데이터 불러오기 실패</p>
          </div>`;
      } else {
        // 뉴스 HTML
        let newsHtml = "";
        if (newsData.articles && newsData.articles.length > 0) {
          newsHtml = `
            <ul class="mt-2">
              ${newsData.articles.map(a => 
                `<li><a href="${a.url}" target="_blank">${a.title}</a> <small class="text-muted">(${a.source})</small></li>`
              ).join("")}
            </ul>`;
        } else {
          newsHtml = `<p class="text-muted">관련 뉴스 없음</p>`;
        }

        const cardId = `card-${r.code}`;

        col.innerHTML = `
          <div class="card p-3 mb-3" id="${cardId}">
            <h6>${data.longName || r.name} (${data.symbol})</h6>
            <p class="fw-bold">${data.price} ${data.currency}</p>
            <p class="text-muted">전일종가: ${data.previousClose || "-"} | 시가: ${data.open || "-"}</p>
            <p class="text-muted">고가/저가: ${data.dayHigh || "-"} / ${data.dayLow || "-"}</p>
            <p class="text-muted">시가총액: ${data.marketCap || "-"}</p>

            <!-- 탭 네비 -->
            <ul class="nav nav-tabs mt-3" id="tabs-${r.code}" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="news-tab-${r.code}" data-bs-toggle="tab" data-bs-target="#news-${r.code}" type="button" role="tab">뉴스</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="ai-tab-${r.code}" data-bs-toggle="tab" data-bs-target="#ai-${r.code}" type="button" role="tab">AI 분석</button>
              </li>
            </ul>
            <div class="tab-content p-2 border border-top-0">
              <div class="tab-pane fade show active" id="news-${r.code}" role="tabpanel">${newsHtml}</div>
              <div class="tab-pane fade" id="ai-${r.code}" role="tabpanel"><p class="text-muted">AI 분석 불러오는 중...</p></div>
            </div>
          </div>`;

        // AI 분석 비동기 로딩
        fetchAnalysis(r.name, data.price, newsData.articles).then(result => {
          const aiDiv = col.querySelector(`#ai-${r.code}`);
          aiDiv.innerHTML = `<p>${result.summary.replace(/\n/g, "<br>")}</p>`;
        });
      }

      container.appendChild(col);
    }
  }

  loadRetailers();
</script>
