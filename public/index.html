<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>부자재구매 Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body {font-family:'SUIT Variable','Pretendard',sans-serif;background:#fafafa;color:#111;}
    .section-title {font-weight:800;margin:40px 0 20px;border-bottom:2px solid #e5e7eb;padding-bottom:8px;}
    .card {border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,0.05);}
  </style>
</head>
<body>
  <div class="container py-4">

    <!-- Header -->
    <div class="text-center mb-5">
      <h1 class="fw-bold">부자재구매 Dashboard</h1>
      <p class="text-muted">Hansol Textile Purchasing Division</p>
    </div>

    <!-- 1. KPI Manual 입력 -->
    <h3 class="section-title">1. KPI (Manual 입력)</h3>
    <div class="row g-3">
      <div class="col-md-3"><div class="card p-3 text-center"><h5>총 매입액</h5><p class="fs-4 fw-bold">₩ ---</p></div></div>
      <div class="col-md-3"><div class="card p-3 text-center"><h5>총 스타일 수</h5><p class="fs-4 fw-bold">---</p></div></div>
      <div class="col-md-3"><div class="card p-3 text-center"><h5>총 Cost Save</h5><p class="fs-4 fw-bold">₩ ---</p></div></div>
      <div class="col-md-3"><div class="card p-3 text-center"><h5>총 PO 건수</h5><p class="fs-4 fw-bold">---</p></div></div>
    </div>

    <!-- 2. 주요 지표 -->
    <h3 class="section-title">2. 주요 지표</h3>
    <div class="row g-3">
      <div class="col-md-3"><div class="card p-3">환율 (USD/KRW): <span id="fx">---</span></div></div>
      <div class="col-md-3"><div class="card p-3">면화 가격: <span id="cotton">---</span></div></div>
      <div class="col-md-3"><div class="card p-3">SCFI 지수: <span id="scfi">---</span></div></div>
      <div class="col-md-3"><div class="card p-3">유가 (WTI): <span id="oil">---</span></div></div>
      <div class="col-md-4"><div class="card p-3">미국 CPI (Apparel): <span id="cpiApparel">---</span></div></div>
      <div class="col-md-4"><div class="card p-3">리테일 판매액 (의류): <span id="retailSales">---</span></div></div>
      <div class="col-md-4"><div class="card p-3">재고/판매 비율 (의류): <span id="inventoryRatio">---</span></div></div>
    </div>
    <div class="text-end mt-2">
      <button class="btn btn-outline-primary btn-sm">더보기</button>
      <button class="btn btn-primary btn-sm">AI 분석보기</button>
    </div>

    <!-- 3. 주요 Retailer 주가 -->
    <h3 class="section-title">3. 주요 Retailer 주가</h3>
    <div class="row g-3" id="retailers"></div>

    <!-- 4. 원부자재 현황 -->
    <h3 class="section-title">4. 원부자재 현황</h3>
    <div class="card p-3">Cotton/Polyester 그래프 자리</div>

    <!-- 5. 주요 섬유 뉴스 -->
    <h3 class="section-title">5. 주요 섬유 뉴스</h3>
    <div class="card p-3">뉴스 카드 자리</div>

    <!-- 6. 사내 부자재 사고 -->
    <h3 class="section-title">6. 사내 부자재 사고</h3>
    <div class="card p-3"><ul><li>샘플 사고</li></ul></div>

    <!-- 7. 발주시 유의사항 -->
    <h3 class="section-title">7. 발주시 유의사항 (Chatbot)</h3>
    <div class="card p-3">Chatbot 자리</div>

    <!-- 8. 기타 자료 -->
    <h3 class="section-title">8. 기타 부자재 자료</h3>
    <div class="card p-3"><ul><li><a href="#">샘플자료.pdf</a></li></ul></div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // 2. 주요 지표 데이터 로드
    async function loadIndicators() {
      try {
        const res = await fetch("/api/indicators");
        const data = await res.json();

        document.getElementById("fx").innerText = data.usdKrw ? data.usdKrw.toLocaleString() : "-";
        document.getElementById("cotton").innerText = data.cotton ? data.cotton + " ¢/lb" : "-";
        document.getElementById("scfi").innerText = data.scfi || "-";
        document.getElementById("oil").innerText = data.oil ? data.oil + " USD" : "-";
        document.getElementById("cpiApparel").innerText = data.cpiApparel ? data.cpiApparel.toFixed(2) : "-";
        document.getElementById("retailSales").innerText = data.retailSales ? data.retailSales.toLocaleString() : "-";
        document.getElementById("inventoryRatio").innerText = data.inventoryRatio ? data.inventoryRatio.toFixed(2) : "-";
      } catch (err) {
        console.error("지표 로딩 실패", err);
      }
    }
    loadIndicators();

    // 3. 주요 Retailer 주가 + 뉴스 + AI 분석
    const retailers = [
      { code: "WMT", name: "Walmart" },
      { code: "TGT", name: "Target" },
      { code: "KSS", name: "Kohl's" },
      { code: "VSCO", name: "Victoria's Secret" },
      { code: "ANF", name: "Abercrombie & Fitch" },
      { code: "CRI", name: "Carter's" },
      { code: "9983.T", name: "Fast Retailing (Uniqlo)" },
      { code: "AMZN", name: "Amazon" },
      { code: "BABA", name: "Alibaba.com" }
    ];

    async function fetchStock(symbol) {
      try {
        const res = await fetch(`/api/stocks?symbol=${encodeURIComponent(symbol)}`);
        if (!res.ok) throw new Error("API 요청 실패");
        return await res.json();
      } catch (err) {
        console.error(symbol, err);
        return { error: true, symbol };
      }
    }

    async function fetchNews(query) {
      try {
        const res = await fetch(`/api/news?q=${encodeURIComponent(query)}`);
        if (!res.ok) throw new Error("뉴스 API 요청 실패");
        return await res.json();
      } catch (err) {
        console.error("뉴스 오류:", query, err);
        return { articles: [] };
      }
    }

    async function fetchAnalysis(name, price, news) {
      try {
        const res = await fetch("/api/analysis", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, price, news }),
        });
        if (!res.ok) throw new Error("분석 API 실패");
        return await res.json();
      } catch (err) {
        console.error("AI 분석 오류:", err);
        return { summary: "분석 불가" };
      }
    }

    async function loadRetailers() {
      const container = document.getElementById("retailers");
      container.innerHTML = "";

      for (const r of retailers) {
        const [data, newsData] = await Promise.all([
          fetchStock(r.code),
          fetchNews(r.name)
        ]);

        const col = document.createElement("div");
        col.className = "col-md-6";

        if (data.error) {
          col.innerHTML = `
            <div class="card p-3 mb-3">
              <h6>${r.name} (${r.code})</h6>
              <p class="text-danger">데이터 불러오기 실패</p>
            </div>`;
        } else {
          // 뉴스 HTML
          let newsHtml = "";
          if (newsData.articles && newsData.articles.length > 0) {
            newsHtml = `
              <ul class="mt-2">
                ${newsData.articles.map(a => 
                  `<li><a href="${a.url}" target="_blank">${a.title}</a> <small class="text-muted">(${a.source})</small></li>`
                ).join("")}
              </ul>`;
          } else {
            newsHtml = `<p class="text-muted">관련 뉴스 없음</p>`;
          }

          const cardId = `card-${r.code}`;
          const aiTabId = `ai-${r.code}`;

          col.innerHTML = `
            <div class="card p-3 mb-3" id="${cardId}">
              <h6>${data.longName || r.name} (${data.symbol})</h6>
              <p class="fw-bold">${data.price} ${data.currency}</p>
              <p class="text-muted">전일종가: ${data.previousClose || "-"} | 시가: ${data.open || "-"}</p>
              <p class="text-muted">고가/저가: ${data.dayHigh || "-"} / ${data.dayLow || "-"}</p>
              <p class="text-muted">시가총액: ${data.marketCap || "-"}</p>

              <!-- 탭 네비 -->
              <ul class="nav nav-tabs mt-3" id="tabs-${r.code}" role="tablist">
                <li class="nav-item" role="presentation">
                  <button class="nav-link active" id="news-tab-${r.code}" data-bs-toggle="tab" data-bs-target="#news-${r.code}" type="button" role="tab">뉴스</button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="ai-tab-${r.code}" data-bs-toggle="tab" data-bs-target="#ai-${r.code}" type="button" role="tab">AI 분석</button>
                </li>
              </ul>
              <div class="tab-content p-2 border border-top-0">
                <div class="tab-pane fade show active" id="news-${r.code}" role="tabpanel">${newsHtml}</div>
                <div class="tab-pane fade" id="ai-${r.code}" role="tabpanel">
                  <p class="text-muted">AI 분석 탭을 클릭하면 결과가 표시됩니다.</p>
                </div>
              </div>
            </div>`;

          // AI 탭 이벤트 바인딩 (클릭할 때마다 새로 호출)
          col.querySelector(`#ai-tab-${r.code}`).addEventListener("click", async () => {
            const aiDiv = col.querySelector(`#${aiTabId}`);
            aiDiv.innerHTML = `<p class="text-muted">분석 중...</p>`;
            const result = await fetchAnalysis(r.name, data.price, newsData.articles);
            aiDiv.innerHTML = `<p>${result.summary.replace(/\n/g, "<br>")}</p>`;
          });
        }

        container.appendChild(col);
      }
    }

    loadRetailers();
  </script>
</body>
</html>
