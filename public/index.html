<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hansol Textile · Market Insight</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { margin:0; font-family:'Segoe UI',sans-serif; background:#fff; color:#111;}
    header { padding:1rem 1.5rem; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;}
    header h1 { font-size:1.2rem; margin:0; font-weight:600; color:#005BAC;}
    header small { font-size:0.85rem; color:#666;}
    main { padding:1.5rem; display:grid; gap:2rem; max-width:1200px; margin:auto;}
    h2 { margin:0 0 1rem; font-size:1.1rem; font-weight:600; color:#333;}
    .stocks { width:100%; border-collapse:collapse; font-size:0.9rem; border:1px solid #eee; border-radius:8px; overflow:hidden;}
    .stocks th, .stocks td { padding:0.8rem; border-bottom:1px solid #eee; text-align:center;}
    .stocks th { background:#fafafa; font-weight:600;}
    .stocks tr:last-child td { border-bottom:none;}
    .price { font-size:1.1rem; font-weight:600;}
    .positive { color:#1FA857; font-weight:600;}
    .negative { color:#D64541; font-weight:600;}
    .sparkline { width:100px; height:40px;}
    .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:1rem;}
    .card { border:1px solid #eee; border-radius:12px; padding:1rem; background:#fafafa;}
    .card strong { display:block; font-size:0.85rem; color:#666;}
    .card .value { font-size:1.2rem; font-weight:600; margin-top:0.2rem;}
    .news-list { display:grid; gap:0.8rem;}
    .news-item { padding:0.8rem 1rem; border:1px solid #eee; border-radius:8px;}
    .news-item h3 { margin:0 0 0.3rem; font-size:0.95rem; font-weight:500;}
    .news-item small { color:#777; font-size:0.8rem;}
    footer { padding:1rem; text-align:center; font-size:0.8rem; color:#888; border-top:1px solid #eee;}
  </style>
</head>
<body>
  <header>
    <h1>Hansol Textile · Market Insight</h1>
    <small id="date">자동 업데이트</small>
  </header>
  <main>
    <section id="stocks">
      <h2>📊 리테일러 주가</h2>
      <table class="stocks" id="stocks-table">
        <thead>
          <tr><th>Ticker</th><th>Name</th><th>Price</th><th>Change</th><th>Trend</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
    <section id="kpi">
      <h2>📈 주요 지표</h2>
      <div class="grid" id="kpi-cards"></div>
    </section>
    <section id="news">
      <h2>📰 최신 뉴스</h2>
      <div class="news-list" id="news-list"></div>
    </section>
    <section id="analysis">
      <h2>🤖 AI 시황 분석</h2>
      <div class="card" id="analysis-card">불러오는 중...</div>
    </section>
  </main>
  <footer>
    © Hansol Textile · Purchasing Division
  </footer>

<script>
async function init() {
  try {
    // 📊 Stocks API
    const stocksRes = await fetch("/api/stocks");
    const stocks = await stocksRes.json();
    const tbody = document.querySelector("#stocks-table tbody");
    tbody.innerHTML = "";
    stocks.forEach((r, idx)=>{
      const tr = document.createElement("tr");
      const change = parseFloat(r.changePercent);
      let changeHTML = "";
      if (change > 0) changeHTML = `<span class="positive">▲ ${change.toFixed(2)}%</span>`;
      else if (change < 0) changeHTML = `<span class="negative">▼ ${Math.abs(change).toFixed(2)}%</span>`;
      else changeHTML = `<span>${change.toFixed(2)}%</span>`;
      tr.innerHTML = `
        <td>${r.symbol}</td>
        <td>${r.name}</td>
        <td class="price">${r.price}</td>
        <td>${changeHTML}</td>
        <td><canvas id="chart-${idx}" class="sparkline"></canvas></td>
      `;
      tbody.appendChild(tr);
      // Trend Chart
      new Chart(document.getElementById("chart-"+idx), {
        type: 'line',
        data: {
          labels: ["Mon","Tue","Wed","Thu","Fri"],
          datasets: [{
            data: [r.price*0.95, r.price*0.97, r.price*1.01, r.price*0.99, r.price],
            borderColor: (change>=0?"#1FA857":"#D64541"),
            borderWidth: 2,
            fill: false,
            tension: 0.3,
            pointRadius: 0
          }]
        },
        options: { plugins:{legend:{display:false}}, scales:{x:{display:false},y:{display:false}} }
      });
    });

    // 📈 KPI (경제 지표, FRED API)
    const kpiRes = await fetch("/api/fred");
    const kpis = await kpiRes.json();
    const kpiDiv = document.getElementById("kpi-cards");
    kpiDiv.innerHTML = "";
    kpis.forEach(k=>{
      const card = document.createElement("div");
      card.className="card";
      card.innerHTML=`<strong>${k.name}</strong><div class="value">${k.value}</div><small>${k.date||""}</small>`;
      kpiDiv.appendChild(card);
    });

    // 📰 News
    const newsRes = await fetch("/api/news");
    const news = await newsRes.json();
    const newsList = document.getElementById("news-list");
    newsList.innerHTML = "";
    news.forEach(n=>{
      const div=document.createElement("div");
      div.className="news-item";
      div.innerHTML=`<h3>${n.title}</h3><small>${n.source} · ${n.date}</small>`;
      newsList.appendChild(div);
    });

    // 🤖 AI Analysis
    const analysisRes = await fetch("/api/analysis");
    const analysis = await analysisRes.json();
    document.getElementById("analysis-card").innerText = analysis.text;

    // Date
    document.getElementById("date").innerText = new Date().toLocaleString("ko-KR");
  } catch(e){ 
    console.error(e); 
  }
}
init();
</script>
</body>
</html>
